---
title: "consort_diagram"
author: "Daniel Johnson"
date: "2022-08-11"
output:
  pdf_document:
    toc: yes
    toc_depth: '2'
  html_notebook:
    theme: journal
    toc: yes
    toc_depth: 2
    toc_float: yes
---
# Setup

```{r setup, include=FALSE}
library(knitr)
library(tidyverse)
library(haven)
library(consort)

knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

# Data sources
```{r data_in}
load("C:/Users/dyjohnson/OneDrive/Documents/Research/SRP/full_list_consort.RData")
```

# CONSORT diagram
```{r consort}
consort <- full_list %>%
  group_by(PX_ID) %>%
  summarise(
    trialno = PX_ID,
    min_stat = min(as.numeric(as.character(CANHX_STAT_CD))),
    exc1 = case_when(
      !can_stat_min %in% c(2110, 2120, 2130, 2140, 2150, 2160, 2999) ~ "Listed using previous classification
      system",
      can_stat_min == 2999 ~ "Listed as permanently inactive",
      WL_ORG != "HR" ~ "Listed for multiple organs",
      can_listing_ctr_count < 10 ~ "Listed at a low-volume center (<10 heart
      transplant candidates per year)"#,
      # active_time < 14 ~ "Less than 14 days active on the waiting 
      # list"
    ),
    arm3 = rec_exception_init_ever,
    .groups = "drop"
  ) %>%
  distinct()

consort_plot <- consort_plot(
  data = consort,
  orders = c(
    trialno = "All candidates â‰¥18 years old listed in 
    SRTR database from October 18, 2018 
    to December 1, 2021",
    exc1    = "Exclusions",
    trialno = "Study cohort",
    arm3 = "Exception status",
    trialno = "Final analysis"
  ),
  side_box = c("exc1"),
  allocation = "arm3",
  cex = 0.9
)

plot(consort_plot)

ggsave("consort.png", plot = consort_plot)
```